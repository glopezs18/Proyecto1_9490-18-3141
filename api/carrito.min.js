const express=require("express"),mongoose=require("mongoose"),{usersModel:usersModel,productsModel:productsModel,purchaseModel:purchaseModel}=require("../includes/models.js");var all_cart=require("../includes/items.js");const jwt=require("jsonwebtoken"),cart_products=[];var cart_total=0,carrito=express.Router();function verifyToken(req,res,next){const bearerHeader=req.headers.authorization;if(void 0!==bearerHeader){const bearerToken=bearerHeader.split(" ")[1];req.token=bearerToken,next()}else res.sendStatus(403)}carrito.use(express.json()),mongoose.connect("mongodb://127.0.0.1:27017/proyecto1_9490-18-3141"),carrito.get("/",verifyToken,(function(req,res){jwt.verify(req.token,"secretkey",(error,authData)=>{error?res.sendStatus(403):res.json(all_cart)})})),carrito.post("/",verifyToken,(function(req,res){const cart={_id:req.body.id,cantidad:req.body.cantidad};jwt.verify(req.token,"secretkey",(error,authData)=>{error?res.sendStatus(403):productsModel.findById({_id:cart._id}).then((function(product){if(product.habilitado)if(product.disponibilidad>=cart.cantidad){cart_products.push({_id:product._id,nombre:product.nombre,marca:product.marca,disponibilidad:product.disponibilidad-cart.cantidad,descuento:product.descuento,precio:product.precio,precioDescuento:product.precioDescuento,imagen:product.imagen,descripcion:product.descripcion,cantidad:cart.cantidad,total:product.precioDescuento*cart.cantidad}),cart_total+=product.precioDescuento*cart.cantidad;const dataUpdateProduct={disponibilidad:product.disponibilidad-cart.cantidad,habilitado:!1};productsModel.findByIdAndUpdate({_id:cart._id},dataUpdateProduct).catch(err=>res.json(err)),all_cart={productos:cart_products,total:cart_total},res.json({mesage:"Producto agregado al carrito de compras"})}else res.json({message:"No hay la disponibilidad deseada de este producto en este momento",disponibilidad:product.disponibilidad,nombre:product.nombre,id:product._id});else res.json({message:"Este producto no está habilitado.",nombre:product.nombre,id:product._id})})).catch((function(err){console.log(err)}))})})),carrito.put("/:id",verifyToken,(function(req,res){const cart={_id:req.params.id,cantidad:req.body.cantidad};var nuevaCantidad=0;jwt.verify(req.token,"secretkey",(error,authData)=>{if(error)res.sendStatus(403);else{const objIndex=cart_products.findIndex(obj=>obj._id==cart._id);cart.cantidad<cart_products[objIndex].cantidad?(nuevaCantidad=cart_products[objIndex].cantidad-cart.cantidad,cart_products[objIndex].disponibilidad=cart_products[objIndex].disponibilidad+nuevaCantidad,cart_total-=cart_products[objIndex].precioDescuento*nuevaCantidad):(nuevaCantidad=cart.cantidad-cart_products[objIndex].cantidad,cart_products[objIndex].disponibilidad=cart_products[objIndex].disponibilidad-nuevaCantidad,cart_total+=cart_products[objIndex].precioDescuento*nuevaCantidad),cart_products[objIndex].cantidad=cart.cantidad,cart_products[objIndex].total=cart_products[objIndex].precioDescuento*cart.cantidad;const dataUpdateProduct={disponibilidad:cart_products[objIndex].disponibilidad};productsModel.findByIdAndUpdate({_id:cart._id},dataUpdateProduct).catch(err=>res.json(err)),all_cart={productos:cart_products,total:cart_total},res.json(all_cart)}})})),carrito.delete("/:id",verifyToken,(function(req,res){const id=req.params.id;jwt.verify(req.token,"secretkey",(error,authData)=>{if(error)res.sendStatus(403);else{const product=cart_products.find(p=>p._id==id);if(!product)return res.status(402).json({message:"No se encontró el producto indicado"});const objIndex=cart_products.findIndex(obj=>obj._id==id),updatedDisponibilidad=cart_products[objIndex].disponibilidad+cart_products[objIndex].cantidad;cart_total-=cart_products[objIndex].total;const dataUpdateProduct={disponibilidad:updatedDisponibilidad,habilitado:!0};productsModel.findByIdAndUpdate({_id:id},dataUpdateProduct).catch(err=>res.json(err)),cart_products.splice(objIndex,1),all_cart={productos:cart_products,total:cart_total},res.json({success:"Se eliminó el producto con id: "+id+" del carrito de compras "})}})})),carrito.post("/compra",verifyToken,(function(req,res){jwt.verify(req.token,"secretkey",(error,authData)=>{error?res.sendStatus(403):usersModel.find({correoElectronico:authData.user.correoElectronico}).then((function(data){const validate=data[0].clave==authData.user.clave;if(validate){const dataCartPurchase={id_usuario:data[0]._id,nombre_usuario:data[0].nombres+" "+data[0].apellidos,datosCarrito:all_cart};purchaseModel.create(dataCartPurchase).then(()=>{all_cart.productos.map(element=>{productsModel.findByIdAndUpdate({_id:element._id},{habilitado:!0}).then(res.json({message:"Compra realizada con éxito.",info:dataCartPurchase})).catch(err=>res.json(err))})}).catch(err=>res.json(err))}})).catch((function(err){console.log(err)}))})})),module.exports=carrito;